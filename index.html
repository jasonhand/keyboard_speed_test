<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Datadog Typing Test & Keyboard Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Datadog RUM SDK -->
    <script>
      (function(h,o,u,n,d) {
        h=h[d]=h[d]||{q:[],onReady:function(c){h.q.push(c)}}
        d=o.createElement(u);d.async=1;d.src=n
        n=o.getElementsByTagName(u)[0];n.parentNode.insertBefore(d,n)
      })(window,document,'script','https://www.datadoghq-browser-agent.com/us1/v6/datadog-rum.js','DD_RUM')
      window.DD_RUM.onReady(function() {
        window.DD_RUM.init({
          clientToken: 'pubc7932cbc69c976016659135760251538',
          applicationId: 'b7e70078-1335-4a18-abc8-30a557d61174',
          site: 'datadoghq.com',
          service: 'keyboard-speed-tests',
          env: 'prod',
          version: '1.2.0', // Updated version for this fix
          sessionSampleRate: 100,
          sessionReplaySampleRate: 100,
          defaultPrivacyLevel: 'mask-user-input',
        });
      })
    </script>
    <!-- End Datadog RUM SDK -->

    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background-image: url('https://imgix.datadoghq.com/img/products/bits-ai/bits_ai_hero_desktop.png?ch=Width,DPR,Save-Data&fm=png&auto=format&fit=max');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(17, 24, 39, 0.85); /* gray-900 with 85% opacity */
            z-index: -1;
        }
        .caret {
            animation: blink 1s infinite;
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }
        .correct { color: #4ade80; } /* green-400 */
        .incorrect { color: #f87171; text-decoration: underline; } /* red-400 */
        .untyped { color: #9ca3af; } /* gray-400 */
        
        /* Toast Animation */
        .toast-enter {
            transform: translateY(100%);
            opacity: 0;
        }
        .toast-enter-active {
            transform: translateY(0);
            opacity: 1;
            transition: all 0.3s ease-out;
        }
        .toast-exit {
            transform: translateY(0);
            opacity: 1;
        }
        .toast-exit-active {
            transform: translateY(100%);
            opacity: 0;
            transition: all 0.3s ease-in;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 flex items-center justify-center min-h-screen p-4">

    <!-- Datadog Logo Accent -->
    <div class="fixed top-8 right-8 z-5 pointer-events-none">
        <img src="https://external-content.duckduckgo.com/iu/?u=https%3A%2F%2Fcompanieslogo.com%2Fimg%2Forig%2FDDOG-60ca9565.png%3Ft%3D1634120747&f=1&nofb=1&ipt=fe4e1b3b5b6e283f6f9205dbc7de1145a3d6392fb6c3dab316e6c94042e65832" 
             alt="Datadog Logo" 
             class="w-16 h-16 opacity-20 hover:opacity-30 transition-opacity duration-300">
    </div>
    
    <!-- Datadog Logo Accent Bottom Left -->
    <div class="fixed bottom-8 left-8 z-5 pointer-events-none">
        <img src="https://external-content.duckduckgo.com/iu/?u=https%3A%2F%2Fcompanieslogo.com%2Fimg%2Forig%2FDDOG-60ca9565.png%3Ft%3D1634120747&f=1&nofb=1&ipt=fe4e1b3b5b6e283f6f9205dbc7de1145a3d6392fb6c3dab316e6c94042e65832" 
             alt="Datadog Logo" 
             class="w-12 h-12 opacity-10 hover:opacity-20 transition-opacity duration-300">
    </div>

    <div id="app" class="w-full max-w-4xl mx-auto relative z-10">

        <!-- Setup Screen -->
        <div id="setup-screen" class="text-center space-y-8">
            <h1 class="text-5xl font-bold text-white">Datadog Typing Test</h1>
            <p class="text-lg text-gray-400">Test your typing speed with Datadog documentation. Share your results and compete on the leaderboard!</p>
            <div class="bg-gray-800 p-6 rounded-lg shadow-lg max-w-md mx-auto space-y-4">
                <div>
                    <label for="user-name" class="block text-sm font-medium text-gray-300 mb-2">Your Name</label>
                    <input type="text" id="user-name" class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="Enter your name...">
                </div>
                <button id="start-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-md transition duration-300 ease-in-out transform hover:scale-105">
                    Start Typing Test
                </button>
            </div>
            
            <!-- Leaderboard Section -->
            <div class="bg-gray-800 p-6 rounded-lg shadow-lg max-w-4xl mx-auto">
                <h2 class="text-2xl font-bold text-white mb-4">Leaderboard</h2>
                <div id="leaderboard-container" class="space-y-2">
                    <div class="text-gray-400 text-sm">No results yet. Be the first to complete a test!</div>
                </div>
                <div class="mt-4 text-center">
                    <button id="copy-leaderboard-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md transition duration-300">
                        Copy Leaderboard URL
                    </button>
                </div>
            </div>
        </div>

        <!-- Typing Test Screen -->
        <div id="test-screen" class="hidden">
            <div class="grid grid-cols-4 gap-4 text-center mb-6">
                <div id="wpm-display" class="bg-gray-800 p-4 rounded-lg"><span class="text-4xl font-bold">0</span><span class="text-gray-400"> WPM</span></div>
                <div id="acc-display" class="bg-gray-800 p-4 rounded-lg"><span class="text-4xl font-bold">100</span><span class="text-gray-400">% Acc</span></div>
                <div id="errors-display" class="bg-gray-800 p-4 rounded-lg"><span class="text-4xl font-bold">0</span><span class="text-gray-400"> Errors</span></div>
                <div id="timer-display" class="bg-gray-800 p-4 rounded-lg"><span class="text-4xl font-bold">30</span><span class="text-gray-400">s</span></div>
            </div>
            <div id="text-prompt-container" class="relative bg-gray-800 p-6 rounded-lg text-2xl leading-relaxed font-mono tracking-wider mb-4" style="min-height: 160px;">
                <p id="text-prompt"></p>
                <div id="caret" class="caret absolute bg-indigo-500" style="width: 2px; height: 2rem; top: 1.5rem; left: 1.5rem;"></div>
            </div>
            <input type="text" id="typing-input" class="opacity-0 absolute" autofocus>
            <div class="text-center">
                <button id="restart-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-md transition duration-300">Restart</button>
            </div>
        </div>

        <!-- Results Screen -->
        <div id="results-screen" class="hidden text-center bg-gray-800 p-8 rounded-lg shadow-2xl">
            <h2 class="text-4xl font-bold mb-4">Test Complete!</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 text-white">
                <div class="bg-gray-700 p-4 rounded-lg">
                    <p class="text-gray-400 text-sm">WPM</p>
                    <p id="result-wpm" class="text-5xl font-bold">0</p>
                </div>
                <div class="bg-gray-700 p-4 rounded-lg">
                    <p class="text-gray-400 text-sm">Accuracy</p>
                    <p id="result-acc" class="text-5xl font-bold">0%</p>
                </div>
                <div class="bg-gray-700 p-4 rounded-lg">
                    <p class="text-gray-400 text-sm">Name</p>
                    <p id="result-keyboard" class="text-2xl font-semibold mt-3 truncate" title="User Name">N/A</p>
                </div>
            </div>
            <div class="mb-6">
                <p class="text-gray-400 text-sm mb-2">Share Your Result</p>
                <input type="text" id="share-url" class="w-full bg-gray-600 border border-gray-500 rounded-md px-3 py-2 text-gray-200 focus:outline-none" readonly>
            </div>
            <div id="datadog-source" class="mb-6 hidden">
                <p class="text-gray-400 text-sm mb-2">Text Source</p>
                <a id="datadog-link" href="#" target="_blank" class="text-indigo-400 hover:text-indigo-300 underline break-all">
                    View in Datadog Documentation
                </a>
            </div>
            <div class="mb-6">
                <p class="text-gray-400 text-sm mb-2">Ready to try Datadog?</p>
                <a href="https://app.datadoghq.com" target="_blank" class="inline-block bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-md transition duration-300 transform hover:scale-105">
                    Try Datadog Free
                </a>
            </div>
            <div class="flex justify-center space-x-4">
                <button id="new-test-btn" class="w-1/2 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-md transition duration-300">New Test</button>
                <button id="copy-url-btn" class="w-1/2 bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-md transition duration-300">Copy URL</button>
            </div>
        </div>

    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed bottom-4 left-4 right-4 z-50 pointer-events-none relative">
        <div id="bits-toast" class="hidden bg-gray-800 border border-gray-600 rounded-lg p-4 shadow-2xl max-w-md mx-auto pointer-events-auto">
            <div class="flex items-start space-x-3">
                <div class="flex-shrink-0">
                    <div class="w-8 h-8 bg-indigo-600 rounded-full flex items-center justify-center">
                        <span class="text-white text-sm font-bold">B</span>
                    </div>
                </div>
                <div class="flex-1 min-w-0">
                    <div class="flex items-center space-x-2 mb-2">
                        <span class="text-white font-semibold">Bits AI</span>
                        <span class="text-gray-400 text-sm">just now</span>
                    </div>
                    <p class="text-gray-300 mb-3">Great job! Would you like to start over or share your result?</p>
                    <div class="flex space-x-2">
                        <button id="toast-new-test" class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1 rounded text-sm transition duration-200">
                            Start Over
                        </button>
                        <button id="toast-share" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-sm transition duration-200">
                            Share
                        </button>
                        <button id="toast-dismiss" class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded text-sm transition duration-200">
                            Dismiss
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const app = document.getElementById('app');
            const setupScreen = document.getElementById('setup-screen');
            const testScreen = document.getElementById('test-screen');
            const resultsScreen = document.getElementById('results-screen');

            const userNameInput = document.getElementById('user-name');
            const startBtn = document.getElementById('start-btn');
            const copyLeaderboardBtn = document.getElementById('copy-leaderboard-btn');
            const leaderboardContainer = document.getElementById('leaderboard-container');
            
            // Toast elements
            const bitsToast = document.getElementById('bits-toast');
            const toastNewTest = document.getElementById('toast-new-test');
            const toastShare = document.getElementById('toast-share');
            const toastDismiss = document.getElementById('toast-dismiss');
            
            const wpmDisplay = document.getElementById('wpm-display').querySelector('span:first-child');
            const accDisplay = document.getElementById('acc-display').querySelector('span:first-child');
            const errorsDisplay = document.getElementById('errors-display').querySelector('span:first-child');
            const timerDisplay = document.getElementById('timer-display').querySelector('span:first-child');
            
            const textPromptContainer = document.getElementById('text-prompt-container');
            const textPrompt = document.getElementById('text-prompt');
            const typingInput = document.getElementById('typing-input');
            const caret = document.getElementById('caret');
            const restartBtn = document.getElementById('restart-btn');

            const resultWpm = document.getElementById('result-wpm');
            const resultAcc = document.getElementById('result-acc');
            const resultKeyboard = document.getElementById('result-keyboard');
            const shareUrlInput = document.getElementById('share-url');
            const newTestBtn = document.getElementById('new-test-btn');
            const copyUrlBtn = document.getElementById('copy-url-btn');
            const datadogSource = document.getElementById('datadog-source');
            const datadogLink = document.getElementById('datadog-link');

            // --- Datadog Documentation Snippets ---
            const datadogSnippets = [
                {
                    text: "Datadog is a monitoring and analytics platform for IT infrastructure, cloud services, and applications. It provides real-time visibility into your entire technology stack.",
                    source: "https://docs.datadoghq.com/getting_started/",
                    title: "Getting Started"
                },
                {
                    text: "The Datadog Agent is a lightweight daemon that runs on your hosts and collects events and metrics from hosts and sends them to Datadog, where you can analyze your monitoring and performance data.",
                    source: "https://docs.datadoghq.com/agent/",
                    title: "Datadog Agent"
                },
                {
                    text: "APM (Application Performance Monitoring) provides deep visibility into your application's performance by tracing requests as they flow through your services and infrastructure.",
                    source: "https://docs.datadoghq.com/tracing/",
                    title: "APM & Distributed Tracing"
                },
                {
                    text: "Logs provide visibility into the behavior of your applications and infrastructure. They help you understand how your applications are performing and troubleshoot issues.",
                    source: "https://docs.datadoghq.com/logs/",
                    title: "Log Management"
                },
                {
                    text: "Infrastructure monitoring gives you visibility into your hosts, containers, and cloud services. Monitor your infrastructure in real-time and get alerted when issues arise.",
                    source: "https://docs.datadoghq.com/infrastructure/",
                    title: "Infrastructure Monitoring"
                },
                {
                    text: "Real User Monitoring (RUM) enables you to visualize and analyze the real-time performance and user journeys of your application's individual users.",
                    source: "https://docs.datadoghq.com/real_user_monitoring/",
                    title: "Real User Monitoring"
                },
                {
                    text: "Synthetic monitoring allows you to create automated tests that simulate user requests and actions to ensure your applications are working correctly from the user's perspective.",
                    source: "https://docs.datadoghq.com/synthetics/",
                    title: "Synthetic Monitoring"
                },
                {
                    text: "Security monitoring helps you detect threats and vulnerabilities in your infrastructure and applications. Monitor for security events and get alerted when potential threats are detected.",
                    source: "https://docs.datadoghq.com/security_platform/",
                    title: "Security Platform"
                },
                {
                    text: "Dashboards provide a customizable view of your metrics, logs, and traces. Create visualizations to monitor your infrastructure and applications in real-time.",
                    source: "https://docs.datadoghq.com/dashboards/",
                    title: "Dashboards"
                },
                {
                    text: "Alerts notify you when your metrics exceed certain thresholds. Configure alerting rules to ensure you're notified of issues before they impact your users.",
                    source: "https://docs.datadoghq.com/monitors/",
                    title: "Monitors"
                }
            ];

            // --- App State ---
            let state = {
                testDuration: 30,
                timer: null,
                timeLeft: 30,
                testActive: false,
                promptText: '',
                typedChars: 0,
                correctChars: 0,
                errorCount: 0,
                userName: 'Unknown',
                useDatadog: true,
                datadogSource: null
            };

            // --- Functions ---
            const init = () => {
                const urlParams = new URLSearchParams(window.location.search);
                
                // Check if URL contains leaderboard data
                if (urlParams.has('lb0_wpm')) {
                    loadLeaderboardFromURL(urlParams);
                    showSetupScreen();
                } else if (urlParams.has('wpm')) {
                    displayResultsFromURL(urlParams);
                } else {
                    showSetupScreen();
                }
                
                // Always update leaderboard display
                updateLeaderboardDisplay();
                addEventListeners();
            };

            const addEventListeners = () => {
                startBtn.addEventListener('click', startTest);
                restartBtn.addEventListener('click', () => {
                    if (window.DD_RUM && typeof window.DD_RUM.addAction === 'function') {
                        window.DD_RUM.addAction('restart_test', {
                            context: {
                                timeLeft: state.timeLeft,
                                typedChars: state.typedChars
                            }
                        });
                    }
                    resetTest();
                });
                newTestBtn.addEventListener('click', () => {
                    window.history.pushState({}, '', window.location.pathname);
                    showSetupScreen();
                });
                copyUrlBtn.addEventListener('click', copyShareUrl);
                copyLeaderboardBtn.addEventListener('click', copyLeaderboardUrl);
                typingInput.addEventListener('input', handleTyping);
                textPromptContainer.addEventListener('click', () => typingInput.focus());
                
                // Toast event listeners
                toastNewTest.addEventListener('click', () => {
                    hideToast();
                    window.history.pushState({}, '', window.location.pathname);
                    showSetupScreen();
                });
                toastShare.addEventListener('click', () => {
                    hideToast();
                    copyShareUrl();
                });
                toastDismiss.addEventListener('click', hideToast);
            };

            const showSetupScreen = () => {
                setupScreen.classList.remove('hidden');
                testScreen.classList.add('hidden');
                resultsScreen.classList.add('hidden');
                hideToast(); // Hide any existing toast
            };

            const showTestScreen = () => {
                setupScreen.classList.add('hidden');
                testScreen.classList.remove('hidden');
                resultsScreen.classList.add('hidden');
                typingInput.focus();
            };

            const showResultsScreen = () => {
                setupScreen.classList.add('hidden');
                testScreen.classList.add('hidden');
                resultsScreen.classList.remove('hidden');
                hideToast(); // Hide any existing toast
            };

            const startTest = () => {
                state.userName = userNameInput.value.trim() || 'Unknown';
                state.timeLeft = state.testDuration;
                state.useDatadog = true;
                timerDisplay.textContent = state.timeLeft;
                
                if (window.DD_RUM && typeof window.DD_RUM.addAction === 'function') {
                    window.DD_RUM.addAction('start_test', {
                        context: {
                            userName: state.userName,
                            testDuration: state.testDuration,
                            useDatadog: state.useDatadog
                        }
                    });
                }

                resetTestState();
                setNewPrompt();
                showTestScreen();
            };
            
            const resetTest = () => {
                clearInterval(state.timer);
                state.timer = null;
                state.timeLeft = state.testDuration;
                timerDisplay.textContent = state.timeLeft;
                resetTestState();
                setNewPrompt();
                typingInput.focus();
            };

            const resetTestState = () => {
                state.testActive = false;
                state.typedChars = 0;
                state.correctChars = 0;
                state.errorCount = 0;
                typingInput.value = '';
                wpmDisplay.textContent = '0';
                accDisplay.textContent = '100';
                errorsDisplay.textContent = '0';
            };

            const setNewPrompt = () => {
                const randomSnippet = datadogSnippets[Math.floor(Math.random() * datadogSnippets.length)];
                state.promptText = randomSnippet.text;
                state.datadogSource = randomSnippet;
                textPrompt.innerHTML = state.promptText.split('').map(char => `<span class="untyped">${char}</span>`).join('');
                updateCaretPosition();
            };

            const handleTyping = () => {
                if (!state.testActive && typingInput.value.length > 0) {
                    startTimer();
                }

                const typedText = typingInput.value;
                const promptSpans = textPrompt.querySelectorAll('span');
                state.typedChars = typedText.length;
                state.correctChars = 0;
                state.errorCount = 0;

                promptSpans.forEach((charSpan, index) => {
                    const char = typedText[index];
                    if (char == null) {
                        charSpan.className = 'untyped';
                    } else if (char === charSpan.innerText) {
                        charSpan.className = 'correct';
                        state.correctChars++;
                    } else {
                        charSpan.className = 'incorrect';
                        state.errorCount++;
                    }
                });
                
                updateStats();
                updateCaretPosition();

                if (state.typedChars === state.promptText.length) {
                    endTest();
                }
            };

            const startTimer = () => {
                state.testActive = true;
                const startTime = Date.now();

                state.timer = setInterval(() => {
                    const elapsedTime = Math.floor((Date.now() - startTime) / 1000);
                    state.timeLeft = state.testDuration - elapsedTime;
                    timerDisplay.textContent = state.timeLeft;
                    
                    if(state.testActive) {
                       updateStats();
                    }

                    if (state.timeLeft <= 0) {
                        endTest();
                    }
                }, 1000);
            };

            const updateStats = () => {
                const elapsedTime = state.testDuration - state.timeLeft;
                const wpm = elapsedTime > 0 ? Math.round((state.correctChars / 5) / (elapsedTime / 60)) : 0;
                const accuracy = state.typedChars > 0 ? Math.round((state.correctChars / state.typedChars) * 100) : 100;

                wpmDisplay.textContent = wpm;
                accDisplay.textContent = accuracy;
                errorsDisplay.textContent = state.errorCount;
            };

            const updateCaretPosition = () => {
                const promptSpans = textPrompt.querySelectorAll('span');
                const lastTypedChar = promptSpans[state.typedChars - 1];
                const nextChar = promptSpans[state.typedChars];

                if (state.typedChars === 0) {
                    caret.style.top = `${nextChar.offsetTop}px`;
                    caret.style.left = `${nextChar.offsetLeft}px`;
                } else if (nextChar) {
                    caret.style.top = `${nextChar.offsetTop}px`;
                    caret.style.left = `${nextChar.offsetLeft}px`;
                } else { 
                    caret.style.top = `${lastTypedChar.offsetTop}px`;
                    caret.style.left = `${lastTypedChar.offsetLeft + lastTypedChar.offsetWidth}px`;
                }
                caret.style.height = `${nextChar ? nextChar.offsetHeight : lastTypedChar.offsetHeight}px`;
            };

            const endTest = () => {
                clearInterval(state.timer);
                state.testActive = false;
                typingInput.blur();

                const elapsedTime = state.testDuration - state.timeLeft;
                const finalWpm = elapsedTime > 0 ? Math.round((state.correctChars / 5) / (elapsedTime / 60)) : 0;
                const finalAccuracy = state.typedChars > 0 ? Math.round((state.correctChars / state.typedChars) * 100) : 100;
                
                if (window.DD_RUM && typeof window.DD_RUM.addAction === 'function') {
                    window.DD_RUM.addAction('test_completed', {
                        context: {
                            wpm: finalWpm,
                            accuracy: finalAccuracy,
                            errors: state.errorCount,
                            userName: state.userName,
                            useDatadog: state.useDatadog
                        }
                    });
                }

                resultWpm.textContent = finalWpm;
                resultAcc.textContent = `${finalAccuracy}%`;
                resultKeyboard.textContent = state.userName;
                resultKeyboard.title = state.userName;

                // Always show Datadog source link since all tests use Datadog content
                if (state.datadogSource) {
                    datadogLink.href = state.datadogSource.source;
                    datadogLink.textContent = `${state.datadogSource.title} - Datadog Documentation`;
                    datadogSource.classList.remove('hidden');
                }

                generateShareUrl(finalWpm, finalAccuracy);
                showResultsScreen();
                
                // Show Bits AI toast after a short delay
                setTimeout(() => {
                    showToast();
                }, 1000);
            };

            const generateShareUrl = (wpm, accuracy) => {
                const params = new URLSearchParams({
                    wpm: wpm,
                    acc: accuracy,
                    name: state.userName,
                    ts: new Date().toISOString(),
                    text: btoa(state.promptText)
                });
                
                // Always add Datadog source info since all tests use Datadog content
                if (state.datadogSource) {
                    params.append('dd', '1');
                    params.append('dd_title', state.datadogSource.title);
                    params.append('dd_source', state.datadogSource.source);
                }
                
                const url = `${window.location.origin}${window.location.pathname}?${params.toString()}`;
                shareUrlInput.value = url;
                window.history.pushState({ wpm, accuracy }, '', url);
                
                // Add to leaderboard
                addToLeaderboard(wpm, accuracy, state.userName);
            };

            const copyShareUrl = () => {
                if (window.DD_RUM && typeof window.DD_RUM.addAction === 'function') {
                    window.DD_RUM.addAction('copy_share_url');
                }
                shareUrlInput.select();
                try {
                    document.execCommand('copy');
                    copyUrlBtn.textContent = 'Copied!';
                    setTimeout(() => { copyUrlBtn.textContent = 'Copy URL'; }, 2000);
                } catch (err) {
                    console.error('Failed to copy URL: ', err);
                    alert('Failed to copy. Please copy the URL manually.');
                }
            };
            
            const displayResultsFromURL = (params) => {
                resultWpm.textContent = params.get('wpm') || 0;
                resultAcc.textContent = `${params.get('acc') || 100}%`;
                const name = params.get('name') || 'Unknown';
                resultKeyboard.textContent = name;
                resultKeyboard.title = name;

                // Handle Datadog source info from URL
                if (params.get('dd') === '1') {
                    const ddTitle = params.get('dd_title') || 'Datadog Documentation';
                    const ddSource = params.get('dd_source') || 'https://docs.datadoghq.com/';
                    datadogLink.href = ddSource;
                    datadogLink.textContent = `${ddTitle} - Datadog Documentation`;
                    datadogSource.classList.remove('hidden');
                } else {
                    datadogSource.classList.add('hidden');
                }

                shareUrlInput.value = window.location.href;
                showResultsScreen();
            };

            // --- Toast Functions ---
            const showToast = () => {
                bitsToast.classList.remove('hidden');
                bitsToast.classList.add('toast-enter');
                
                // Trigger animation
                setTimeout(() => {
                    bitsToast.classList.remove('toast-enter');
                    bitsToast.classList.add('toast-enter-active');
                }, 10);
                
                // Auto-hide after 10 seconds
                setTimeout(() => {
                    hideToast();
                }, 10000);
            };

            const hideToast = () => {
                bitsToast.classList.remove('toast-enter-active');
                bitsToast.classList.add('toast-exit');
                
                setTimeout(() => {
                    bitsToast.classList.add('hidden');
                    bitsToast.classList.remove('toast-exit');
                }, 300);
            };

            // --- Leaderboard Functions ---
            const addToLeaderboard = (wpm, accuracy, name) => {
                const leaderboard = getLeaderboard();
                const entry = {
                    wpm: parseInt(wpm),
                    accuracy: parseInt(accuracy),
                    name: name,
                    timestamp: new Date().toISOString()
                };
                
                // Add new entry
                leaderboard.push(entry);
                
                // Sort by WPM (descending), then by accuracy (descending)
                leaderboard.sort((a, b) => {
                    if (a.wpm !== b.wpm) {
                        return b.wpm - a.wpm;
                    }
                    return b.accuracy - a.accuracy;
                });
                
                // Keep only top 10 entries
                const topEntries = leaderboard.slice(0, 10);
                
                // Save to localStorage
                localStorage.setItem('typing-leaderboard', JSON.stringify(topEntries));
                
                // Update display
                updateLeaderboardDisplay();
            };

            const getLeaderboard = () => {
                try {
                    const stored = localStorage.getItem('typing-leaderboard');
                    return stored ? JSON.parse(stored) : [];
                } catch (e) {
                    return [];
                }
            };

            const updateLeaderboardDisplay = () => {
                const leaderboard = getLeaderboard();
                
                if (leaderboard.length === 0) {
                    leaderboardContainer.innerHTML = '<div class="text-gray-400 text-sm">No results yet. Be the first to complete a test!</div>';
                    return;
                }
                
                const leaderboardHTML = leaderboard.map((entry, index) => {
                    const medal = index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : '';
                    const rank = index + 1;
                    const date = new Date(entry.timestamp).toLocaleDateString();
                    
                    return `
                        <div class="flex items-center justify-between bg-gray-700 p-3 rounded-lg">
                            <div class="flex items-center space-x-3">
                                <span class="text-lg">${medal}</span>
                                <span class="font-bold text-white">#${rank}</span>
                                <span class="text-white">${entry.name}</span>
                            </div>
                            <div class="flex items-center space-x-4 text-sm">
                                <span class="text-green-400">${entry.wpm} WPM</span>
                                <span class="text-blue-400">${entry.accuracy}%</span>
                                <span class="text-gray-400">${date}</span>
                            </div>
                        </div>
                    `;
                }).join('');
                
                leaderboardContainer.innerHTML = leaderboardHTML;
            };

            const copyLeaderboardUrl = () => {
                const leaderboard = getLeaderboard();
                if (leaderboard.length === 0) {
                    alert('No leaderboard entries to share yet!');
                    return;
                }
                
                const params = new URLSearchParams();
                leaderboard.forEach((entry, index) => {
                    params.append(`lb${index}_wpm`, entry.wpm);
                    params.append(`lb${index}_acc`, entry.accuracy);
                    params.append(`lb${index}_name`, entry.name);
                    params.append(`lb${index}_ts`, entry.timestamp);
                });
                
                const url = `${window.location.origin}${window.location.pathname}?${params.toString()}`;
                
                try {
                    navigator.clipboard.writeText(url).then(() => {
                        copyLeaderboardBtn.textContent = 'Copied!';
                        setTimeout(() => { copyLeaderboardBtn.textContent = 'Copy Leaderboard URL'; }, 2000);
                    });
                } catch (err) {
                    // Fallback for older browsers
                    const textArea = document.createElement('textarea');
                    textArea.value = url;
                    document.body.appendChild(textArea);
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        copyLeaderboardBtn.textContent = 'Copied!';
                        setTimeout(() => { copyLeaderboardBtn.textContent = 'Copy Leaderboard URL'; }, 2000);
                    } catch (err) {
                        alert('Failed to copy. Please copy the URL manually: ' + url);
                    }
                    document.body.removeChild(textArea);
                }
            };

            const loadLeaderboardFromURL = (params) => {
                const leaderboard = [];
                let index = 0;
                
                while (params.has(`lb${index}_wpm`)) {
                    const entry = {
                        wpm: parseInt(params.get(`lb${index}_wpm`)),
                        accuracy: parseInt(params.get(`lb${index}_acc`)),
                        name: params.get(`lb${index}_name`),
                        timestamp: params.get(`lb${index}_ts`)
                    };
                    leaderboard.push(entry);
                    index++;
                }
                
                if (leaderboard.length > 0) {
                    localStorage.setItem('typing-leaderboard', JSON.stringify(leaderboard));
                    updateLeaderboardDisplay();
                }
            };

            // --- Start the App ---
            init();
        });
    </script>
</body>
</html>
